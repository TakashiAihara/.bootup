# ~/.zshrc
# Zsh メイン設定ファイル
# 環境変数は ~/.zshenv で設定済み

# ==================== ヒストリ設定 ====================

HISTFILE="${HOME}/.zsh_history"
HISTSIZE=50000
SAVEHIST=50000

setopt EXTENDED_HISTORY       # ヒストリにタイムスタンプを記録
setopt HIST_EXPIRE_DUPS_FIRST # 重複を先に削除
setopt HIST_IGNORE_DUPS       # 連続した重複は無視
setopt HIST_IGNORE_SPACE      # スペースで始まるコマンドは無視
setopt HIST_VERIFY            # ヒストリ展開後に確認
setopt SHARE_HISTORY          # ヒストリを共有

# ==================== 補完設定 ====================

autoload -Uz compinit
compinit -d "${XDG_CACHE_HOME}/zsh/zcompdump"

# 補完スタイル
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# ==================== キーバインド ====================

bindkey -e  # Emacs キーバインド

bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward
bindkey '^P' history-search-backward
bindkey '^N' history-search-forward

# ==================== エイリアス ====================

# ls
if command -v eza &>/dev/null; then
    alias ls="eza --icons"
    alias ll="eza -la --icons --git"
    alias la="eza -a --icons"
    alias lt="eza -T --icons --level=2"
else
    alias ls="ls --color=auto"
    alias ll="ls -la"
    alias la="ls -a"
fi

# cat/bat
if command -v bat &>/dev/null; then
    alias cat="bat --plain"
fi

# grep
alias grep="grep --color=auto"
alias fgrep="fgrep --color=auto"
alias egrep="egrep --color=auto"

# 安全なファイル操作
alias rm="rm -i"
alias mv="mv -i"
alias cp="cp -i"

# ディレクトリ移動
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."

# Git
alias g="git"
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"
alias gd="git diff"
alias gco="git checkout"
alias gb="git branch"
alias glog="git log --oneline --graph --decorate -15"

# lazygit
alias lg="lazygit"

# Kubernetes
if command -v kubectl &>/dev/null; then
    alias k="kubectl"
    alias kgp="kubectl get pods"
    alias kgs="kubectl get services"
    alias kgd="kubectl get deployments"
fi

# Docker
if command -v docker &>/dev/null; then
    alias d="docker"
    alias dc="docker compose"
    alias dps="docker ps"
    alias dimg="docker images"
fi

# ==================== ツール初期化 ====================

# mise
if command -v mise &>/dev/null; then
    eval "$(mise activate zsh)"
fi

# direnv
if command -v direnv &>/dev/null; then
    eval "$(direnv hook zsh)"
fi

# zoxide
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh)"
fi

# fzf
if [[ -f ~/.fzf.zsh ]]; then
    source ~/.fzf.zsh
elif [[ -f /opt/fzf/shell/key-bindings.zsh ]]; then
    source /opt/fzf/shell/key-bindings.zsh
    source /opt/fzf/shell/completion.zsh
{{ if .is_mac -}}
elif [[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]]; then
    source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
    source /opt/homebrew/opt/fzf/shell/completion.zsh
{{ end -}}
fi

export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border"
if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND="fd --type f --hidden --follow --exclude .git"
fi

# ghq + fzf
ghq-fzf() {
    local dir
    dir=$(ghq list | fzf --preview "bat --color=always --style=grid $(ghq root)/{}/README.md 2>/dev/null || ls -la $(ghq root)/{}") && cd "$(ghq root)/$dir"
}
alias ghf="ghq-fzf"

# Starship プロンプト
if command -v starship &>/dev/null; then
    eval "$(starship init zsh)"
fi

# ==================== 環境固有設定 ====================

{{ if .is_wsl -}}
# WSL クリップボード連携
alias pbcopy="clip.exe"
alias pbpaste="powershell.exe -command Get-Clipboard"
{{ end -}}

# ==================== ローカル設定の読み込み ====================

if [[ -f "${HOME}/.zshrc.local" ]]; then
    source "${HOME}/.zshrc.local"
fi
