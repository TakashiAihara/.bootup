#!/bin/bash
# users/.chezmoiscripts/run_onchange_after_mise-config.sh.tmpl
# mise 設定変更時にツールを再インストール

# hash: {{ include "dot_config/mise/config.toml.tmpl" | sha256sum }}

set -eu

echo "=== mise configuration changed, updating tools ==="

{{ if .is_mac -}}
# Homebrew (macOS)
if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{ end -}}

if ! command -v mise &>/dev/null; then
    echo "mise not found, skipping"
    exit 0
fi

# GitHub API rate limit 回避のため GITHUB_TOKEN を設定
if command -v gh &>/dev/null && gh auth status &>/dev/null; then
    export GITHUB_TOKEN=$(gh auth token)
fi

# mise trust for current directory
mise trust ~/.config/mise/config.toml 2>/dev/null || true

# Install all tools defined in config
mise install

echo "=== mise tools updated ==="
