#!/bin/bash
# root/.chezmoiscripts/run_once_before_35-install-cli-tools.sh.tmpl
# CLIツールのインストール（Ubuntu/Linux用）

set -eu

{{ if .use_homebrew -}}
# Homebrew環境ではスキップ（brew経由でインストール）
echo "=== Skipping CLI tools (will be installed via Homebrew) ==="
exit 0
{{ end -}}

{{ if not .is_ubuntu -}}
# Ubuntu以外ではスキップ
echo "=== Skipping CLI tools (Ubuntu only) ==="
exit 0
{{ end -}}

echo "=== Installing CLI tools ==="

# GitHub CLI (gh)
if ! command -v gh &>/dev/null; then
    echo "Installing GitHub CLI..."
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    apt-get update
    apt-get install -y gh
fi

# starship
if ! command -v starship &>/dev/null; then
    echo "Installing starship..."
    STARSHIP_VERSION=$(curl -s https://api.github.com/repos/starship/starship/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/starship/starship/releases/download/v${STARSHIP_VERSION}/starship-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv /tmp/starship /usr/local/bin/starship
    chmod +x /usr/local/bin/starship
fi

# neovim (PPA)
if ! command -v nvim &>/dev/null; then
    echo "Installing neovim..."
    add-apt-repository -y ppa:neovim-ppa/unstable
    apt-get update
    apt-get install -y neovim
fi

# fzf
if ! command -v fzf &>/dev/null; then
    echo "Installing fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git /opt/fzf
    /opt/fzf/install --bin
    ln -sf /opt/fzf/bin/fzf /usr/local/bin/fzf
fi

# ghq
if ! command -v ghq &>/dev/null; then
    echo "Installing ghq..."
    GHQ_VERSION=$(curl -s https://api.github.com/repos/x-motemen/ghq/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/x-motemen/ghq/releases/download/v${GHQ_VERSION}/ghq_linux_amd64.zip" -o /tmp/ghq.zip
    unzip -o /tmp/ghq.zip -d /tmp
    mv /tmp/ghq_linux_amd64/ghq /usr/local/bin/ghq
    chmod +x /usr/local/bin/ghq
    rm -rf /tmp/ghq.zip /tmp/ghq_linux_amd64
fi

# lazygit
if ! command -v lazygit &>/dev/null; then
    echo "Installing lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -fsSL "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" | tar xz -C /usr/local/bin lazygit
fi

# delta (git-delta)
if ! command -v delta &>/dev/null; then
    echo "Installing delta..."
    DELTA_VERSION=$(curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
    curl -fsSL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv "/tmp/delta-${DELTA_VERSION}-x86_64-unknown-linux-musl/delta" /usr/local/bin/delta
    chmod +x /usr/local/bin/delta
    rm -rf "/tmp/delta-${DELTA_VERSION}-x86_64-unknown-linux-musl"
fi

# ripgrep (rg)
if ! command -v rg &>/dev/null; then
    echo "Installing ripgrep..."
    RG_VERSION=$(curl -s https://api.github.com/repos/BurntSushi/ripgrep/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
    curl -fsSL "https://github.com/BurntSushi/ripgrep/releases/download/${RG_VERSION}/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv "/tmp/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl/rg" /usr/local/bin/rg
    chmod +x /usr/local/bin/rg
    rm -rf "/tmp/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl"
fi

# fd
if ! command -v fd &>/dev/null; then
    echo "Installing fd..."
    FD_VERSION=$(curl -s https://api.github.com/repos/sharkdp/fd/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/sharkdp/fd/releases/download/v${FD_VERSION}/fd-v${FD_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv "/tmp/fd-v${FD_VERSION}-x86_64-unknown-linux-musl/fd" /usr/local/bin/fd
    chmod +x /usr/local/bin/fd
    rm -rf "/tmp/fd-v${FD_VERSION}-x86_64-unknown-linux-musl"
fi

# bat
if ! command -v bat &>/dev/null; then
    echo "Installing bat..."
    BAT_VERSION=$(curl -s https://api.github.com/repos/sharkdp/bat/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/sharkdp/bat/releases/download/v${BAT_VERSION}/bat-v${BAT_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv "/tmp/bat-v${BAT_VERSION}-x86_64-unknown-linux-musl/bat" /usr/local/bin/bat
    chmod +x /usr/local/bin/bat
    rm -rf "/tmp/bat-v${BAT_VERSION}-x86_64-unknown-linux-musl"
fi

# eza
if ! command -v eza &>/dev/null; then
    echo "Installing eza..."
    EZA_VERSION=$(curl -s https://api.github.com/repos/eza-community/eza/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/eza-community/eza/releases/download/v${EZA_VERSION}/eza_x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv /tmp/eza /usr/local/bin/eza
    chmod +x /usr/local/bin/eza
fi

# zoxide
if ! command -v zoxide &>/dev/null; then
    echo "Installing zoxide..."
    ZOXIDE_VERSION=$(curl -s https://api.github.com/repos/ajeetdsouza/zoxide/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/ajeetdsouza/zoxide/releases/download/v${ZOXIDE_VERSION}/zoxide-${ZOXIDE_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
    mv /tmp/zoxide /usr/local/bin/zoxide
    chmod +x /usr/local/bin/zoxide
fi

# yq (GitHub releases)
if ! command -v yq &>/dev/null; then
    echo "Installing yq..."
    YQ_VERSION=$(curl -s https://api.github.com/repos/mikefarah/yq/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -fsSL "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
    chmod +x /usr/local/bin/yq
fi

echo "=== CLI tools installation complete ==="
