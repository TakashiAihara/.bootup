#!/bin/bash
# root/.chezmoiscripts/run_once_before_20-install-homebrew.sh.tmpl
# Homebrew インストール

set -eu

{{ if not .use_homebrew -}}
# Homebrew を使用しない環境ではスキップ
echo "=== Skipping Homebrew (not required for this environment) ==="
exit 0
{{ end -}}

echo "=== Installing Homebrew ==="

{{ if .is_mac -}}
# macOS
if command -v brew &>/dev/null; then
    echo "✓ Homebrew is already installed"
    brew update
else
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
{{ else -}}
# Linux (Linuxbrew)
HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"

if [[ -x "${HOMEBREW_PREFIX}/bin/brew" ]]; then
    echo "✓ Homebrew is already installed"
    "${HOMEBREW_PREFIX}/bin/brew" update
else
    echo "Installing Homebrew on Linux..."
    
    # 必要な依存パッケージ
    apt-get install -y \
        build-essential \
        procps \
        curl \
        file \
        git
    
    # Homebrew インストール
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
{{ end -}}

echo "=== Homebrew installation complete ==="
