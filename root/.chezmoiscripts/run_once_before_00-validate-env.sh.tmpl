#!/bin/bash
# root/.chezmoiscripts/run_once_before_00-validate-env.sh.tmpl
# 環境検証、前提条件チェック

set -eu

echo "=== Validating environment ==="

# ARCH と AREA のチェック
ARCH="{{ .arch }}"
AREA="{{ .area }}"

echo "ARCH: ${ARCH}"
echo "AREA: ${AREA}"

# 有効な値かチェック
case "${ARCH}" in
    wsl|ubuntu|ubuntu-dev|ubuntu_nat|mac)
        echo "✓ Valid ARCH"
        ;;
    *)
        echo "✗ Invalid ARCH: ${ARCH}"
        exit 1
        ;;
esac

case "${AREA}" in
    home|gcp|oci|conoha)
        echo "✓ Valid AREA"
        ;;
    *)
        echo "✗ Invalid AREA: ${AREA}"
        exit 1
        ;;
esac

# OS チェック
{{ if .is_mac -}}
if [[ "$(uname -s)" != "Darwin" ]]; then
    echo "✗ Expected macOS but running on $(uname -s)"
    exit 1
fi
echo "✓ Running on macOS"
{{ else -}}
if [[ "$(uname -s)" != "Linux" ]]; then
    echo "✗ Expected Linux but running on $(uname -s)"
    exit 1
fi
echo "✓ Running on Linux"
{{ end -}}

# root 権限チェック
if [[ $EUID -ne 0 ]]; then
    echo "✗ This script requires root privileges"
    exit 1
fi
echo "✓ Running as root"

echo "=== Environment validation complete ==="
