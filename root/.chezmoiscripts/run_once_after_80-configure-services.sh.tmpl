#!/bin/bash
# root/.chezmoiscripts/run_once_after_80-configure-services.sh.tmpl
# サービス設定・有効化

set -eu

{{ if .is_container -}}
# コンテナ内では systemd が使えないのでスキップ
echo "=== Skipping service configuration (running inside container) ==="
exit 0
{{ end -}}

{{ if .is_mac -}}
# macOS では systemd は使用しない
echo "=== Skipping service configuration (macOS) ==="
exit 0
{{ end -}}

echo "=== Configuring services ==="

# ==================== Docker ====================

{{ if not .is_container -}}
if command -v docker &>/dev/null; then
    if systemctl is-enabled docker &>/dev/null; then
        echo "✓ Docker service already enabled"
    else
        echo "Enabling Docker service..."
        systemctl enable docker
        systemctl start docker
        echo "✓ Docker service enabled and started"
    fi
fi
{{ end -}}

# ==================== UFW ====================
# ファイアウォールは SG (Security Group) 等の外部で管理
# Docker との競合も避けるため無効化

if command -v ufw &>/dev/null; then
    if ufw status | grep -q "Status: inactive"; then
        echo "✓ UFW already disabled"
    else
        echo "Disabling UFW (firewall managed externally)..."
        ufw --force disable
        echo "✓ UFW disabled"
    fi
fi

{{ if .is_server -}}
# ==================== fail2ban ====================

if command -v fail2ban-server &>/dev/null; then
    if systemctl is-enabled fail2ban &>/dev/null; then
        echo "✓ fail2ban already enabled"
    else
        echo "Enabling fail2ban..."
        systemctl enable fail2ban
        systemctl start fail2ban
        echo "✓ fail2ban enabled and started"
    fi
fi
{{ end -}}

echo "=== Service configuration complete ==="
